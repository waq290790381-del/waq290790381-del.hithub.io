<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>WeChat RP (哈基米精修版)</title>
  <style>
    /* 全局重置 */
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
        background: #f5f5f5; /* 微信经典灰底 */
        height: 100vh; 
        display: flex; 
        flex-direction: column; 
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
    }

    /* 顶部标题栏 */
    .header {
        height: 50px;
        background: #f5f5f5;
        border-bottom: 1px solid #e5e5e5;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        font-weight: 600;
        font-size: 17px;
        z-index: 10;
    }
    /* 设置按钮（齿轮） */
    .settings-btn {
        position: absolute;
        right: 15px;
        font-size: 20px;
        cursor: pointer;
        opacity: 0.7;
    }

    /* 聊天区域 */
    .chat-container { 
        flex: 1; 
        overflow-y: auto; 
        padding: 15px; 
        display: flex; 
        flex-direction: column; 
        gap: 15px;
        background: #f5f5f5;
    }

    /* 消息气泡 */
    .message-row {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        max-width: 100%;
    }
    .message-row.user { flex-direction: row-reverse; }
    
    .avatar {
        width: 40px;
        height: 40px;
        border-radius: 6px;
        background-color: #ddd;
        background-size: cover;
        flex-shrink: 0;
    }
    /* 默认头像颜色 */
    .avatar.ai { background-image: url('https://api.dicebear.com/7.x/adventurer/svg?seed=Felix'); background-color: white; } 
    .avatar.user { background-image: url('https://api.dicebear.com/7.x/adventurer/svg?seed=User'); background-color: #a0e959; }

    .bubble {
        padding: 10px 14px;
        font-size: 16px;
        line-height: 1.5;
        border-radius: 6px;
        position: relative;
        word-break: break-word;
        white-space: pre-wrap;
        max-width: 70vw;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    /* 气泡颜色 */
    .user .bubble { 
        background: #95ec69; /* 微信绿 */
        color: black;
    }
    .user .bubble::after { /* 小三角 */
        content: ''; position: absolute; right: -6px; top: 14px;
        border-top: 6px solid transparent; border-bottom: 6px solid transparent;
        border-left: 6px solid #95ec69;
    }

    .ai .bubble { 
        background: white; 
        color: black;
    }
    .ai .bubble::after { /* 小三角 */
        content: ''; position: absolute; left: -6px; top: 14px;
        border-top: 6px solid transparent; border-bottom: 6px solid transparent;
        border-right: 6px solid white;
    }

    /* 底部输入区 */
    .input-area { 
        padding: 10px; 
        background: #f7f7f7; 
        border-top: 1px solid #dcdcdc; 
        display: flex; 
        align-items: flex-end; 
        gap: 10px; 
        min-height: 50px;
    }
    .input-area textarea { 
        flex: 1; 
        padding: 10px; 
        border: none; 
        border-radius: 6px; 
        outline: none; 
        background: white;
        font-size: 16px;
        resize: none;
        max-height: 100px;
        font-family: inherit;
    }
    .input-area button { 
        padding: 8px 16px; 
        background: #07c160; 
        color: white; 
        border: none; 
        border-radius: 6px; 
        font-weight: bold; 
        font-size: 14px;
        margin-bottom: 2px; /* 对齐 */
    }
    .input-area button:disabled { background: #e0e0e0; color: #aaa; }

    /* 设置弹窗 (Modal) */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 100;
    }
    .modal {
        background: white;
        width: 85%;
        max-width: 400px;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .modal h3 { margin-bottom: 15px; text-align: center; color: #333; }
    .modal label { display: block; margin-top: 10px; font-size: 14px; color: #666; }
    .modal input, .modal textarea { 
        width: 100%; padding: 8px; margin-top: 5px; 
        border: 1px solid #ddd; border-radius: 6px; 
        font-size: 14px;
    }
    .modal textarea { height: 80px; }
    .modal-close {
        margin-top: 20px;
        width: 100%;
        padding: 10px;
        background: #07c160;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
    }
  </style>
</head>
<body>

  <!-- 顶部标题 -->
  <div class="header">
    <span id="chatTitle">Qwen 教授</span>
    <div class="settings-btn" onclick="toggleSettings()">⚙️</div>
  </div>

  <!-- 聊天内容 -->
  <div class="chat-container" id="chatContainer">
    <!-- 消息会动态插在这里 -->
  </div>

  <!-- 底部输入框 -->
  <div class="input-area">
    <textarea id="userInput" rows="1" placeholder="说点什么..."></textarea>
    <button id="sendBtn">发送</button>
  </div>

  <!-- 设置弹窗 -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal">
      <h3>⚙️ 设置</h3>
      <label>API Key:</label>
      <input id="apiKey" type="password" placeholder="sk-xxx">
      
      <label>模型 (Model):</label>
      <input id="model" value="qwen-max">
      
      <label>对方昵称:</label>
      <input id="botName" value="Qwen 教授" oninput="document.getElementById('chatTitle').innerText = this.value">

      <label>人设 (System Prompt):</label>
      <textarea id="systemPrompt" placeholder="例如：你是一个斯文败类教授...">你是一个乐于助人的AI助手。</textarea>
      
      <button class="modal-close" onclick="toggleSettings()">保存并关闭</button>
    </div>
  </div>

  <script>
    const chatContainer = document.getElementById('chatContainer');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const modal = document.getElementById('settingsModal');

    // 自动调整输入框高度
    userInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        if(this.value === '') this.style.height = 'auto';
    });

    // 切换设置弹窗
    function toggleSettings() {
        modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        // 保存设置到 localStorage
        if (modal.style.display === 'none') {
            localStorage.setItem('rp_settings', JSON.stringify({
                apiKey: document.getElementById('apiKey').value,
                model: document.getElementById('model').value,
                systemPrompt: document.getElementById('systemPrompt').value,
                botName: document.getElementById('botName').value
            }));
        }
    }

    // 加载设置和历史
    const savedSettings = JSON.parse(localStorage.getItem('rp_settings') || '{}');
    if (savedSettings.apiKey) document.getElementById('apiKey').value = savedSettings.apiKey;
    if (savedSettings.model) document.getElementById('model').value = savedSettings.model;
    if (savedSettings.systemPrompt) document.getElementById('systemPrompt').value = savedSettings.systemPrompt;
    if (savedSettings.botName) {
        document.getElementById('botName').value = savedSettings.botName;
        document.getElementById('chatTitle').innerText = savedSettings.botName;
    }

    let messages = JSON.parse(localStorage.getItem('chatMessages') || '[]');
    renderMessages();

    function renderMessages() {
      chatContainer.innerHTML = '';
      messages.forEach(msg => {
        const row = document.createElement('div');
        row.className = `message-row ${msg.role === 'user' ? 'user' : 'ai'}`;
        
        const avatar = document.createElement('div');
        avatar.className = `avatar ${msg.role === 'user' ? 'user' : 'ai'}`;
        
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.textContent = msg.content;

        row.appendChild(avatar);
        row.appendChild(bubble);
        chatContainer.appendChild(row);
      });
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    async function sendMessage() {
      const content = userInput.value.trim();
      if (!content) return;

      const apiKey = document.getElementById('apiKey').value;
      const model = document.getElementById('model').value;
      const systemPrompt = document.getElementById('systemPrompt').value;

      if (!apiKey) { alert('请先点击右上角设置 API Key！'); toggleSettings(); return; }

      // 添加用户消息
      messages.push({ role: 'user', content });
      localStorage.setItem('chatMessages', JSON.stringify(messages));
      renderMessages();

      userInput.value = '';
      userInput.style.height = 'auto'; // 重置高度
      sendBtn.disabled = true;
      sendBtn.innerText = '...';

      // 构造请求 (这里用的是阿里云 Dashscope 兼容 OpenAI 格式的接口)
      // 注意：如果你的 Key 是 Dashscope 的，BaseURL 通常是这个
      const baseUrl = "https://dashscope.aliyuncs.com/compatible-mode/v1";

      try {
        const res = await fetch(baseUrl + '/chat/completions', { 
            method: 'POST', 
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: model,
                messages: [
                    { role: 'system', content: systemPrompt },
                    ...messages.slice(-20) // 只带最近20条，省钱！
                ],
                stream: false
            })
        });

        const data = await res.json();

        if (!res.ok) throw new Error(data.error?.message || '请求失败');

        const aiMsg = data.choices[0]?.message?.content || '（无回复）';
        messages.push({ role: 'assistant', content: aiMsg });
        localStorage.setItem('chatMessages', JSON.stringify(messages));
        renderMessages();
      } catch (err) {
        alert('出错了：' + err.message);
      } finally {
        sendBtn.disabled = false;
        sendBtn.innerText = '发送';
      }
    }

    sendBtn.addEventListener('click', sendMessage);
  </script>
</body>
</html>